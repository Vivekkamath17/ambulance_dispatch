<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispatcher Dashboard - QuickResponse</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Custom Tailwind Configuration and Base Styles */
        :root {
            --color-primary: #f44336; /* Red */
            --color-secondary: #1f253e; /* Deep Navy Blue */
            --color-success: #4CAF50; /* Green */
            --color-accent: #ffc107; /* Yellow/Accent */
            --color-muted: #f3f4f6; /* Light gray background */
            --color-tabs: #e5e7eb; /* Gray for TabsList background */
            --color-red-600: #dc2626; /* Specific red for critical */
        }
        
        /* Apply Custom Colors */
        .text-primary { color: var(--color-primary); }
        .bg-primary { background-color: var(--color-primary); }
        .hover\:bg-primary\/90:hover { background-color: rgba(244, 67, 54, 0.9); }
        .bg-success { background-color: var(--color-success); }
        .text-success { color: var(--color-success); }
        .bg-success\/10 { background-color: rgba(76, 175, 80, 0.1); }
        .border-success\/20 { border-color: rgba(76, 175, 80, 0.2); }
        .text-secondary { color: var(--color-secondary); }
        .bg-secondary { background-color: var(--color-secondary); }
        .fill-accent { fill: var(--color-accent); }
        .text-accent { color: var(--color-accent); }
        .bg-accent\/10 { background-color: rgba(255, 193, 7, 0.1); }
        .border-accent\/20 { border-color: rgba(255, 193, 7, 0.2); }
        .bg-primary\/10 { background-color: rgba(244, 67, 54, 0.1); }
        .border-primary\/20 { border-color: rgba(244, 67, 54, 0.2); }
        .bg-red-600 { background-color: var(--color-red-600); }
        .bg-white\/10 { background-color: rgba(255, 255, 255, 0.1); }
        .bg-white\/20 { background-color: rgba(255, 255, 255, 0.2); }
        .bg-muted\/50 { background-color: rgba(243, 244, 246, 0.5); }
        
        /* Gradient for Top Nav */
        .bg-nav-gradient {
            background-image: linear-gradient(to right, var(--color-secondary), #2A4A6F);
        }

        /* General Body and Container */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--color-muted);
        }

        .container {
            max-width: 1440px;
            margin: auto;
        }

        /* Custom Tabs Styling */
        .tabs-list {
            display: grid;
            grid-auto-flow: column;
            background-color: var(--color-tabs);
            border-radius: 8px;
        }
        
        .tabs-trigger {
            padding: 10px 15px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        .tabs-trigger:hover {
            background-color: #d1d5db;
        }
        
        .tabs-trigger.active {
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .tabs-content {
            display: none;
            padding: 20px 0;
        }
        
        .tabs-content.active {
            display: block;
        }
        
        /* Custom Scroll Area (Simulated) */
        .scroll-area {
            overflow-y: auto;
        }

        /* Utility classes for icon replacement */
        .fa-ambulance { color: var(--color-primary); }
        .fa-radiation { color: var(--color-accent); }
        .fa-map-pin { color: var(--color-primary); }
        .fa-route { color: var(--color-success); }
        .fa-clock { color: var(--color-secondary); }
    </style>
</head>
<body class="min-h-screen">

    <!-- Top Bar -->
    <nav class="bg-nav-gradient text-white sticky top-0 z-50 shadow-lg">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <i class="fas fa-satellite-dish h-8 w-8 text-primary text-3xl animate-pulse"></i>
            <div>
              <div class="text-xl font-semibold">Dispatch Command Center</div>
              <div class="text-xs text-white/70">Operator: Sarah Mitchell - Station Alpha</div>
            </div>
          </div>
          
          <div class="flex items-center gap-6">
            <!-- System Status -->
            <div class="flex items-center gap-2 bg-white/10 rounded-lg px-4 py-2 hidden lg:flex">
              <i class="fas fa-check-circle h-5 w-5 text-success animate-pulse"></i>
              <div>
                <div class="text-xs text-white/70">System Status</div>
                <div class="text-sm font-medium">All Systems Operational</div>
              </div>
            </div>
            
            <!-- Active Dispatchers -->
            <div class="flex items-center gap-2 bg-white/10 rounded-lg px-4 py-2 hidden md:flex">
              <i class="fas fa-users h-5 w-5"></i>
              <div>
                <div class="text-xs text-white/70">Active Dispatchers</div>
                <div class="text-sm font-medium">8 Online</div>
              </div>
            </div>
            
            <button class="px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-red-600 hover:bg-red-700 text-white shadow-md animate-pulse">
                <i class="fas fa-triangle-exclamation mr-2 h-4 w-4"></i>
                Emergency Alert
            </button>
            
            <button class="w-10 h-10 p-0 rounded-lg bg-transparent text-white hover:bg-white/10">
              <i class="fas fa-cog h-5 w-5"></i>
            </button>
            
            <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center cursor-pointer font-semibold">
              SM
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <div class="mb-4 flex items-center justify-between">
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 flex-1">
                <!-- Stat: Available Units -->
                <div class="p-4 rounded-xl border border-gray-200 shadow-sm bg-white">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-ambulance h-6 w-6 text-success text-xl"></i>
                        <span id="stat-available-count" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-success text-white">4</span>
                    </div>
                    <div class="text-sm text-gray-500">Available Units</div>
                </div>
                
                <!-- Stat: Units in Service -->
                <div class="p-4 rounded-xl border border-gray-200 shadow-sm bg-white">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-route h-6 w-6 text-primary text-xl"></i>
                        <span id="stat-busy-count" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary text-white">2</span>
                    </div>
                    <div class="text-sm text-gray-500">Units in Service</div>
                </div>
                
                <!-- Stat: Trips Today -->
                <div class="p-4 rounded-xl border border-gray-200 shadow-sm bg-white">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-chart-line h-6 w-6 text-accent text-xl"></i>
                        <span id="stat-trips-today" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-accent text-white">45</span>
                    </div>
                    <div class="text-sm text-gray-500">Trips Today</div>
                </div>
                
                <!-- Stat: Avg Response -->
                <div class="p-4 rounded-xl border border-gray-200 shadow-sm bg-white">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-clock h-6 w-6 text-secondary text-xl"></i>
                        <span id="stat-avg-response" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-secondary text-white">6.8m</span>
                    </div>
                    <div class="text-sm text-gray-500">Avg Response</div>
                </div>
            </div>
            
            <button onclick="window.location.href='login.html'" class="ml-4 h-10 px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 shadow-sm self-center">
                <i class="fas fa-sign-out-alt mr-2 h-4 w-4"></i>
                Exit
            </button>
        </div>

        <div class="grid grid-cols-12 gap-6">
            <!-- Left Column - Fleet Overview (3/12) -->
            <div class="col-span-12 md:col-span-3">
                <div class="bg-white rounded-xl p-4 shadow-sm h-full flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="flex items-center gap-2 text-lg font-semibold text-gray-800">
                            <i class="fas fa-ambulance h-5 w-5 text-primary"></i>
                            Fleet Overview
                        </h3>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium border border-gray-300 text-gray-700" id="fleet-total-count">6</span>
                    </div>
                    
                    <div id="fleet-overview-list" class="flex-1 space-y-2 scroll-area h-[calc(100vh-380px)] md:h-[calc(100vh-320px)]">
                        <!-- Fleet items populated by JavaScript -->
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-200 space-y-2">
                        <button class="w-full text-xs py-2 px-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 shadow-sm">
                            <i class="fas fa-broadcast-tower mr-2 h-3 w-3"></i>
                            Broadcast to All
                        </button>
                        <button class="w-full text-xs py-2 px-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 shadow-sm">
                            <i class="fas fa-map-marker-alt mr-2 h-3 w-3"></i>
                            View Map
                        </button>
                    </div>
                </div>
            </div>

            <!-- Center Column - Request Queue & Active Trips (6/12) -->
            <div class="col-span-12 md:col-span-6 space-y-6">
                <!-- Incoming Requests -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="flex items-center gap-2 text-lg font-semibold text-gray-800">
                            <i class="fas fa-exclamation-triangle h-5 w-5 text-primary"></i>
                            Incoming Requests
                            <span id="request-count-badge" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary text-white ml-2 animate-pulse">3</span>
                        </h3>
                        <select id="sort-requests-select" class="p-2 border border-gray-300 rounded-lg text-sm">
                            <option value="priority">Sort by Priority</option>
                            <option value="time">Sort by Time</option>
                            <option value="location">Sort by Location</option>
                        </select>
                    </div>

                    <div id="request-queue-list" class="scroll-area h-[300px] space-y-3">
                        <!-- Request items populated by JavaScript -->
                    </div>
                </div>

                <!-- Active Trips Monitor -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <h3 class="mb-4 flex items-center gap-2 text-lg font-semibold text-gray-800">
                        <i class="fas fa-chart-line h-5 w-5 text-primary"></i>
                        Active Trips
                        <span id="active-trips-count" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary text-white ml-2">2</span>
                    </h3>

                    <div id="active-trips-list" class="space-y-3">
                        <!-- Active trip items populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Right Column - Messages & Performance (3/12) -->
            <div class="col-span-12 md:col-span-3 space-y-6">
                
                <!-- System Alerts -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <h3 class="mb-4 flex items-center gap-2 text-lg font-semibold text-gray-800">
                        <i class="fas fa-bell h-5 w-5 text-accent"></i>
                        System Alerts
                    </h3>
                    <div id="system-alerts-list" class="scroll-area h-[200px] space-y-2">
                        <!-- System alerts populated by JavaScript -->
                    </div>
                </div>

                <!-- Quick Messages / Broadcast -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <h3 class="mb-4 flex items-center gap-2 text-lg font-semibold text-gray-800">
                        <i class="fas fa-comments h-5 w-5 text-secondary"></i>
                        Quick Messages
                    </h3>
                    <div id="quick-messages-list" class="scroll-area h-[200px] mb-3 space-y-2">
                        <!-- Messages populated by JavaScript -->
                    </div>
                    
                    <textarea id="broadcast-textarea" placeholder="Type a broadcast message..." class="w-full p-2 border border-gray-300 rounded-lg mb-2 text-sm" rows="2"></textarea>
                    <button class="w-full px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-secondary hover:bg-gray-800 text-white shadow-md">
                        <i class="fas fa-paper-plane mr-2 h-4 w-4"></i>
                        Broadcast to All Units
                    </button>
                </div>

                <!-- Performance Today -->
                <div class="p-6 rounded-xl text-white shadow-xl" style="background: linear-gradient(to bottom right, var(--color-secondary), #2A4A6F);">
                    <h3 class="mb-4 text-lg font-semibold">Performance Today</h3>
                    <div class="space-y-3">
                        <div class="space-y-1">
                            <div class="text-2xl font-bold" id="perf-trips">45</div>
                            <div class="text-xs text-white/70">Total Dispatches</div>
                        </div>
                        <div class="h-px bg-white/20"></div>
                        <div class="space-y-1">
                            <div class="text-2xl font-bold" id="perf-avg-time">6.8m</div>
                            <div class="text-xs text-white/70">Avg Response Time</div>
                        </div>
                        <div class="h-px bg-white/20"></div>
                        <div class="space-y-1">
                            <div class="text-2xl font-bold">96%</div>
                            <div class="text-xs text-white/70">Success Rate</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Section - Command Center Tabs (Simplified) -->
        <div class="bg-white rounded-xl mt-6 p-6 shadow-sm">
            <div id="tabs-list" class="grid w-full tabs-list">
                <button class="tabs-trigger active" data-tab="overview">Overview</button>
                <button class="tabs-trigger" data-tab="trips">All Trips</button>
                <button class="tabs-trigger" data-tab="drivers">Driver Management</button>
                <button class="tabs-trigger" data-tab="hospitals">Hospital Network</button>
                <button class="tabs-trigger" data-tab="reports">Reports</button>
                <button class="tabs-trigger" data-tab="settings">Settings</button>
            </div>

            <div id="tabs-content-container">
                <div id="tabs-content-overview" class="tabs-content active text-center py-8 text-gray-500">
                    <i class="fas fa-chart-bar h-12 w-12 mx-auto mb-4 text-primary text-3xl"></i>
                    <p>System overview and real-time statistics</p>
                </div>
                <div id="tabs-content-trips" class="tabs-content text-center py-8 text-gray-500">
                    <i class="fas fa-ambulance h-12 w-12 mx-auto mb-4 text-primary text-3xl"></i>
                    <p>Complete trip history and analytics</p>
                </div>
                <div id="tabs-content-drivers" class="tabs-content text-center py-8 text-gray-500">
                    <i class="fas fa-users h-12 w-12 mx-auto mb-4 text-primary text-3xl"></i>
                    <p>Driver performance, schedules, and certifications</p>
                </div>
                <div id="tabs-content-hospitals" class="tabs-content text-center py-8 text-gray-500">
                    <i class="fas fa-hospital h-12 w-12 mx-auto mb-4 text-primary text-3xl"></i>
                    <p>Partner hospital network and availability</p>
                </div>
                <div id="tabs-content-reports" class="tabs-content text-center py-8 text-gray-500">
                    <i class="fas fa-chart-line h-12 w-12 mx-auto mb-4 text-primary text-3xl"></i>
                    <p>Generate custom reports and analytics</p>
                </div>
                <div id="tabs-content-settings" class="tabs-content text-center py-8 text-gray-500">
                    <i class="fas fa-cog h-12 w-12 mx-auto mb-4 text-primary text-3xl"></i>
                    <p>System configuration and preferences</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:5000';
        const getToken = () => localStorage.getItem('qr_token');
        const getRole = () => localStorage.getItem('qr_role');

        // --- DYNAMIC DATA ---
        let fleetData = [];

        let requestsData = [];
        let activeTripsData = [];
        
        const systemAlertsData = [
            { type: 'critical', message: 'Critical request waiting (REQ-001)', time: '2m ago' },
            { type: 'warning', message: 'AMB-523 offline for maintenance', time: '15m ago' },
            { type: 'info', message: 'New driver logged in: Dr. Lisa Wang', time: '1h ago' }
        ];
        
        const quickMessagesData = [
            { from: 'AMB-247', message: 'Patient loaded, en route to hospital', time: '5m ago', color: 'text-primary' },
            { from: 'AMB-156', message: 'Arrived at pickup location', time: '8m ago', color: 'text-success' }
        ];
        
        // --- HELPER FUNCTIONS ---
        
        const getStatusColorClass = (status) => {
            switch (status) {
                case 'available': return 'bg-success';
                case 'busy': return 'bg-primary';
                case 'offline': return 'bg-gray-500';
                case 'maintenance': return 'bg-accent';
                default: return 'bg-gray-400';
            }
        };

        const getPriorityColorClass = (priority) => {
            switch (priority) {
                case 'critical': return 'bg-red-600 animate-pulse';
                case 'high': return 'bg-primary';
                case 'medium': return 'bg-accent';
                default: return 'bg-gray-500';
            }
        };

        const getAlertColorClasses = (type) => {
            switch (type) {
                case 'critical': return 'bg-red-50 border-l-4 border-l-red-600';
                case 'warning': return 'bg-yellow-50 border-l-4 border-l-accent';
                case 'info': return 'bg-blue-50 border-l-4 border-l-secondary';
                default: return 'bg-gray-50 border-l-4 border-l-gray-400';
            }
        };

        // --- RENDERING FUNCTIONS ---
        
        const renderFleet = () => {
            const list = document.getElementById('fleet-overview-list');
            list.innerHTML = fleetData.map(amb => `
                <div class="p-3 rounded-lg border border-gray-200 bg-white hover:shadow-md transition-all cursor-pointer">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full ${getStatusColorClass(amb.status)}"></div>
                            <span class="text-sm font-semibold text-gray-800">${amb.number}</span>
                        </div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${getStatusColorClass(amb.status)} text-white">
                            ${amb.status}
                        </span>
                    </div>
                    <div class="text-xs text-gray-500 mb-1">Driver: ${amb.driver || '—'}</div>
                    <div class="text-xs text-gray-500">ID: ${amb.id}</div>
                </div>
            `).join('');
            
            // Update stats
            document.getElementById('stat-available-count').textContent = fleetData.filter(a => a.status === 'available').length;
            document.getElementById('stat-busy-count').textContent = fleetData.filter(a => a.status === 'busy').length;
            document.getElementById('fleet-total-count').textContent = fleetData.length;
        };

        const renderRequests = () => {
            const list = document.getElementById('request-queue-list');
            list.innerHTML = requestsData.map(req => `
                <div class="border border-gray-200 rounded-xl p-4 bg-white hover:shadow-lg transition-all">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border border-gray-300 text-gray-700">REQ-${req.id}</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white uppercase">pending</span>
                            </div>
                            <div class="mb-2 font-medium text-gray-800">${req.emergencyType || 'Emergency'}</div>
                            <div class="text-sm text-gray-500 space-y-1">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-map-pin h-4 w-4 text-primary mt-0.5"></i>
                                    <span>${req.pickup}</span>
                                </div>
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-hospital h-4 w-4 text-success mt-0.5"></i>
                                    <span>${req.destination}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <select class="p-2 border border-gray-300 rounded-lg text-sm flex-1" data-req-id="${req.id}">
                            <option value="">Select ambulance</option>
                            ${fleetData.filter(a => a.status === 'available').map(amb => `<option value="${amb.number}">${amb.number}</option>`).join('')}
                        </select>
                        <button class="assign-btn px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-success hover:bg-green-600 text-white shadow-md text-sm" data-req-id="${req.id}">
                            <i class="fas fa-paper-plane mr-2 h-4 w-4"></i>
                            Assign
                        </button>
                    </div>
                </div>
            `).join('');
            document.getElementById('request-count-badge').textContent = requestsData.length;
            document.querySelectorAll('.assign-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.getAttribute('data-req-id');
                    const sel = list.querySelector(`select[data-req-id="${id}"]`);
                    const ambulanceNumber = sel?.value;
                    if (!ambulanceNumber) { alert('Select an ambulance'); return; }
                    try {
                        const res = await fetch(`${API_BASE}/api/requests/${id}/assign`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                ...(getToken() ? { 'Authorization': `Bearer ${getToken()}` } : {})
                            },
                            body: JSON.stringify({ ambulanceNumber })
                        });
                        if (!res.ok) {
                            const err = await res.json().catch(() => ({ error: 'Assign failed' }));
                            throw new Error(err.error || 'Assign failed');
                        }
                        await loadData();
                    } catch (err) {
                        alert(err.message);
                    }
                });
            });
        };

        const renderActiveTrips = () => {
            const list = document.getElementById('active-trips-list');
            list.innerHTML = activeTripsData.map(trip => `
                <div class="p-4 bg-white rounded-xl border border-gray-200 border-l-4 border-l-primary shadow-sm">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border border-gray-300 text-gray-700">${trip.id}</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white">${trip.ambulance}</span>
                            </div>
                            <div class="text-sm text-gray-500 mb-1">${trip.driver}</div>
                            <div class="text-sm font-medium text-gray-800">Patient: ${trip.patient}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500 mb-1">ETA</div>
                            <div class="text-xl font-bold text-primary">${trip.eta}m</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="flex justify-between text-xs text-gray-700 mb-1">
                            <span>${trip.status}</span>
                            <span>${trip.progress}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-primary h-2 rounded-full transition-all duration-500" style="width: ${trip.progress}%;"></div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button class="px-3 py-1.5 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 flex-1">
                            <i class="fas fa-phone mr-2 h-3 w-3"></i> Contact
                        </button>
                        <button class="px-3 py-1.5 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 flex-1">
                            <i class="fas fa-map-marker-alt mr-2 h-3 w-3"></i> Track
                        </button>
                        <button class="px-3 py-1.5 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">
                            <i class="fas fa-exclamation-triangle h-3 w-3"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            document.getElementById('active-trips-count').textContent = activeTripsData.length;
        };

        const renderSystemAlerts = () => {
            const list = document.getElementById('system-alerts-list');
            list.innerHTML = systemAlertsData.map(alert => `
                <div class="p-3 rounded-lg text-sm ${getAlertColorClasses(alert.type)}">
                    <div class="mb-1 font-medium">${alert.message}</div>
                    <div class="text-xs text-gray-500">${alert.time}</div>
                </div>
            `).join('');
        };
        
        const renderQuickMessages = () => {
            const list = document.getElementById('quick-messages-list');
            list.innerHTML = quickMessagesData.map(msg => `
                <div class="p-3 rounded-lg bg-gray-50 text-sm">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-semibold ${msg.color}">${msg.from}</span>
                        <span class="text-xs text-gray-500">${msg.time}</span>
                    </div>
                    <div class="text-xs text-gray-800">${msg.message}</div>
                </div>
            `).join('');
        };
        
        // --- TABS LOGIC ---
        
        const handleTabClick = (e) => {
            const tabContainer = document.getElementById('tabs-content-container');
            const targetTab = e.target.getAttribute('data-tab');

            // Deactivate all triggers and content
            document.querySelectorAll('.tabs-trigger').forEach(trigger => {
                trigger.classList.remove('active');
            });
            document.querySelectorAll('.tabs-content').forEach(content => {
                content.classList.remove('active');
            });

            // Activate the clicked trigger and corresponding content
            e.target.classList.add('active');
            document.getElementById(`tabs-content-${targetTab}`).classList.add('active');
        };

        const loadData = async () => {
            try {
                const res = await fetch(`${API_BASE}/api/requests`);
                if (res.ok) {
                    const data = await res.json();
                    const all = data.requests || [];
                    requestsData = all.filter(r => r.status === 'pending');
                    activeTripsData = all.filter(r => ['accepted','enroute','arrived','transporting'].includes(r.status)).map(r => ({
                        id: `TRP-${r.id}`,
                        ambulance: r.assignedAmbulanceId ? `AMB-${r.assignedAmbulanceId}` : 'TBD',
                        driver: 'Assigned',
                        patient: '—',
                        pickup: r.pickup,
                        destination: r.destination,
                        status: r.status,
                        eta: 0,
                        progress: r.status === 'accepted' ? 25 : r.status === 'enroute' ? 50 : r.status === 'arrived' ? 75 : r.status === 'transporting' ? 90 : 0
                    }));
                }
            } catch {}
            renderRequests();
            renderActiveTrips();
        };

        const loadAmbulances = async () => {
            try {
                const res = await fetch(`${API_BASE}/api/ambulances`);
                if (res.ok) {
                    const data = await res.json();
                    fleetData = (data.ambulances || []).map(a => ({
                        id: a.id,
                        number: a.number,
                        status: a.status || 'available',
                        driver: a.driverUserId ? `Driver #${a.driverUserId}` : ''
                    }));
                }
            } catch {}
            renderFleet();
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!getToken() || getRole() !== 'dispatcher') {
                alert('Please login as a Dispatcher');
                window.location.href = 'login.html';
                return;
            }
            document.querySelectorAll('.tabs-trigger').forEach(trigger => trigger.addEventListener('click', handleTabClick));
            renderSystemAlerts();
            renderQuickMessages();
            loadAmbulances();
            loadData();
            setInterval(() => { loadAmbulances(); loadData(); }, 5000);
        });
    </script>

</body>
</html>
