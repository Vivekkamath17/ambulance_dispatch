<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispatcher Dashboard - QuickResponse</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Custom Tailwind Configuration and Base Styles */
        :root {
            --color-primary: #f44336; /* Red */
            --color-secondary: #1f253e; /* Deep Navy Blue */
            --color-success: #4CAF50; /* Green */
            --color-accent: #ffc107; /* Yellow/Accent */
            --color-muted: #f3f4f6; /* Light gray background */
            --color-tabs: #e5e7eb; /* Gray for TabsList background */
            --color-red-600: #dc2626; /* Specific red for critical */
        }
        
        /* Apply Custom Colors */
        .text-primary { color: var(--color-primary); }
        .bg-primary { background-color: var(--color-primary); }
        .hover\:bg-primary\/90:hover { background-color: rgba(244, 67, 54, 0.9); }
        .bg-success { background-color: var(--color-success); }
        .text-success { color: var(--color-success); }
        .bg-success\/10 { background-color: rgba(76, 175, 80, 0.1); }
        .border-success\/20 { border-color: rgba(76, 175, 80, 0.2); }
        .text-secondary { color: var(--color-secondary); }
        .bg-secondary { background-color: var(--color-secondary); }
        .fill-accent { fill: var(--color-accent); }
        .text-accent { color: var(--color-accent); }
        .bg-accent\/10 { background-color: rgba(255, 193, 7, 0.1); }
        .border-accent\/20 { border-color: rgba(255, 193, 7, 0.2); }
        .bg-primary\/10 { background-color: rgba(244, 67, 54, 0.1); }
        .border-primary\/20 { border-color: rgba(244, 67, 54, 0.2); }
        .bg-red-600 { background-color: var(--color-red-600); }
        .bg-white\/10 { background-color: rgba(255, 255, 255, 0.1); }
        .bg-white\/20 { background-color: rgba(255, 255, 255, 0.2); }
        .bg-muted\/50 { background-color: rgba(243, 244, 246, 0.5); }
        
        /* Gradient for Top Nav */
        .bg-nav-gradient {
            background-image: linear-gradient(to right, var(--color-secondary), #2A4A6F);
        }

        /* General Body and Container */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--color-muted);
        }

        .container {
            max-width: 1440px;
            margin: auto;
        }

        /* Custom Tabs Styling */
        .tabs-list {
            display: grid;
            grid-auto-flow: column;
            background-color: var(--color-tabs);
            border-radius: 8px;
        }
        
        .tabs-trigger {
            padding: 10px 15px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        .tabs-trigger:hover {
            background-color: #d1d5db;
        }
        
        .tabs-trigger.active {
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .tabs-content {
            display: none;
            padding: 20px 0;
        }
        
        .tabs-content.active {
            display: block;
        }
        
        /* Custom Scroll Area (Simulated) */
        .scroll-area {
            overflow-y: auto;
        }

        /* Utility classes for icon replacement */
        .fa-ambulance { color: var(--color-primary); }
        .fa-radiation { color: var(--color-accent); }
        .fa-map-pin { color: var(--color-primary); }
        .fa-route { color: var(--color-success); }
        .fa-clock { color: var(--color-secondary); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Bar -->
    <nav class="bg-nav-gradient text-white sticky top-0 z-50 shadow-lg">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <i class="fas fa-satellite-dish h-8 w-8 text-primary text-3xl animate-pulse"></i>
            <div>
              <div class="text-xl font-semibold">Dispatch Command Center</div>
              <div class="text-xs text-white/70">Operator: <span id="dispatcher-name">Dispatcher</span></div>
            </div>
          </div>
          
          <div class="flex items-center gap-6">
            <!-- System Status -->
            <div class="flex items-center gap-2 bg-white/10 rounded-lg px-4 py-2 hidden lg:flex">
              <i class="fas fa-check-circle h-5 w-5 text-success animate-pulse"></i>
              <div>
                <div class="text-xs text-white/70">System Status</div>
                <div class="text-sm font-medium">All Systems Operational</div>
              </div>
            </div>
            
            <!-- Active Dispatchers -->
            <div class="flex items-center gap-2 bg-white/10 rounded-lg px-4 py-2 hidden md:flex">
              <i class="fas fa-users h-5 w-5"></i>
              <div>
                <div class="text-xs text-white/70">Active Dispatchers</div>
                <div class="text-sm font-medium">8 Online</div>
              </div>
            </div>
            
            <button class="px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-red-600 hover:bg-red-700 text-white shadow-md animate-pulse">
                <i class="fas fa-triangle-exclamation mr-2 h-4 w-4"></i>
                Emergency Alert
            </button>
            <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center cursor-pointer font-semibold">
              SM
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="container mx-auto px-4 py-6 flex-1">
        <div class="mb-4 flex items-center justify-between">
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 flex-1">
                <!-- Stat: Available Units -->
                <div class="p-4 rounded-xl border border-gray-200 shadow-sm bg-white">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-ambulance h-6 w-6 text-success text-xl"></i>
                        <span id="stat-available-count" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-success text-white">4</span>
                    </div>
                    <div class="text-sm text-gray-500">Available Units</div>
                </div>
                
                <!-- Stat: Units in Service -->
                <div class="p-4 rounded-xl border border-gray-200 shadow-sm bg-white">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-route h-6 w-6 text-primary text-xl"></i>
                        <span id="stat-busy-count" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary text-white">2</span>
                    </div>
                    <div class="text-sm text-gray-500">Units in Service</div>
                </div>
                
                <!-- Stat: Trips Today -->
                <div class="p-4 rounded-xl border border-gray-200 shadow-sm bg-white">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-chart-line h-6 w-6 text-accent text-xl"></i>
                        <span id="stat-trips-today" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-accent text-white">45</span>
                    </div>
                    <div class="text-sm text-gray-500">Trips Today</div>
                </div>
                
                <!-- Stat: Avg Response -->
                <div class="p-4 rounded-xl border border-gray-200 shadow-sm bg-white">
                    <div class="flex items-center justify-between mb-2">
                        <i class="fas fa-clock h-6 w-6 text-secondary text-xl"></i>
                        <span id="stat-avg-response" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-secondary text-white">6.8m</span>
                    </div>
                    <div class="text-sm text-gray-500">Avg Response</div>
                </div>
            </div>
            
            <button onclick="window.location.href='index.html'" class="ml-4 h-10 px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 shadow-sm self-center">
                <i class="fas fa-sign-out-alt mr-2 h-4 w-4"></i>
                Exit
            </button>
        </div>

        <div class="grid grid-cols-12 gap-6">
            <!-- Left Column - Fleet Overview (3/12) -->
            <div class="col-span-12 md:col-span-3">
                <div class="bg-white rounded-xl p-4 shadow-sm h-full flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="flex items-center gap-2 text-lg font-semibold text-gray-800">
                            <i class="fas fa-ambulance h-5 w-5 text-primary"></i>
                            Fleet Overview
                        </h3>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium border border-gray-300 text-gray-700" id="fleet-total-count">6</span>
                    </div>
                    
                    <div id="fleet-overview-list" class="flex-1 space-y-2 scroll-area h-[calc(100vh-380px)] md:h-[calc(100vh-320px)]">
                        <!-- Fleet items populated by JavaScript -->
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-200 space-y-2">
                        <button class="w-full text-xs py-2 px-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 shadow-sm">
                            <i class="fas fa-broadcast-tower mr-2 h-3 w-3"></i>
                            Broadcast to All
                        </button>
                    </div>
                </div>
            </div>

            <!-- Center Column - Request Queue & Active Trips (6/12) -->
            <div class="col-span-12 md:col-span-6 space-y-6">
                <!-- Incoming Requests -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="flex items-center gap-2 text-lg font-semibold text-gray-800">
                            <i class="fas fa-exclamation-triangle h-5 w-5 text-primary"></i>
                            Incoming Requests
                            <span id="request-count-badge" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary text-white ml-2 animate-pulse">3</span>
                        </h3>
                        <select id="sort-requests-select" class="p-2 border border-gray-300 rounded-lg text-sm">
                            <option value="priority">Sort by Priority</option>
                            <option value="time">Sort by Time</option>
                            <option value="location">Sort by Location</option>
                        </select>
                    </div>

                    <div id="request-queue-list" class="scroll-area h-[300px] space-y-3">
                        <!-- Request items populated by JavaScript -->
                    </div>
                </div>

                <!-- Active Trips Monitor -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <h3 class="mb-4 flex items-center gap-2 text-lg font-semibold text-gray-800">
                        <i class="fas fa-chart-line h-5 w-5 text-primary"></i>
                        Active Trips
                        <span id="active-trips-count" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary text-white ml-2">2</span>
                    </h3>

                    <div id="active-trips-list" class="space-y-3">
                        <!-- Active trip items populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Right Column - Messages & Performance (3/12) -->
            <div class="col-span-12 md:col-span-3 space-y-6">
                
                <!-- System Alerts -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <h3 class="mb-4 flex items-center gap-2 text-lg font-semibold text-gray-800">
                        <i class="fas fa-bell h-5 w-5 text-accent"></i>
                        System Alerts
                    </h3>
                    <div id="system-alerts-list" class="scroll-area h-[200px] space-y-2">
                        <!-- System alerts populated by JavaScript -->
                    </div>
                </div>

                <!-- Quick Messages / Broadcast -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <h3 class="mb-4 flex items-center gap-2 text-lg font-semibold text-gray-800">
                        <i class="fas fa-comments h-5 w-5 text-secondary"></i>
                        Quick Messages
                    </h3>
                    <div id="quick-messages-list" class="scroll-area h-[200px] mb-3 space-y-2">
                        <!-- Messages populated by JavaScript -->
                    </div>
                    
                    <textarea id="broadcast-textarea" placeholder="Type a broadcast message..." class="w-full p-2 border border-gray-300 rounded-lg mb-2 text-sm" rows="2"></textarea>
                    <button id="broadcast-send-btn" class="w-full px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-secondary hover:bg-gray-800 text-white shadow-md">
                        <i class="fas fa-paper-plane mr-2 h-4 w-4"></i>
                        Broadcast to All Units
                    </button>
                </div>
    <script>
        // --- Globals & helpers ---
        const API_BASE = 'http://127.0.0.1:5000';
        const getToken = () => localStorage.getItem('qr_token');
        const getRole = () => localStorage.getItem('qr_role');

        // In-memory state
        let fleetData = [];
        let requestsData = [];
        let activeTripsData = [];
        let quickMessagesData = [];
        const etaMap = {}; // cache stable random ETA per request id
        const systemAlertsData = [
            { type: 'info', message: 'System initialized', time: new Date().toLocaleTimeString() }
        ];

        // --- Utility color mappers ---
        const getStatusColorClass = (status) => {
            switch (status) {
                case 'available': return 'bg-success';
                case 'busy': return 'bg-primary';
                case 'offline': return 'bg-gray-500';
                case 'maintenance': return 'bg-accent';
                default: return 'bg-gray-400';
            }
        };

        const getAlertColorClasses = (type) => {
            switch (type) {
                case 'critical': return 'bg-red-50 border-l-4 border-l-red-600';
                case 'warning': return 'bg-yellow-50 border-l-4 border-l-accent';
                case 'info': return 'bg-blue-50 border-l-4 border-l-secondary';
                default: return 'bg-gray-50 border-l-4 border-l-gray-400';
            }
        };

        // --- Renderers ---
        const renderFleet = () => {
            const list = document.getElementById('fleet-overview-list');
            if (!list) return;
            list.innerHTML = (fleetData || []).map(amb => `
                <div class="p-3 rounded-lg border border-gray-200 bg-white hover:shadow-md transition-all cursor-pointer">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full ${getStatusColorClass(amb.status)}"></div>
                            <span class="text-sm font-semibold text-gray-800">${amb.number}</span>
                        </div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${getStatusColorClass(amb.status)} text-white">
                            ${amb.status}
                        </span>
                    </div>
                    <div class="text-xs text-gray-500 mb-1">Driver: ${amb.driver || '—'}</div>
                    <div class="text-xs text-gray-500">ID: ${amb.id}</div>
                </div>
            `).join('');
            const avail = (fleetData || []).filter(a => a.status === 'available').length;
            const busy = (fleetData || []).filter(a => a.status === 'busy').length;
            const total = (fleetData || []).length;
            const elAvail = document.getElementById('stat-available-count'); if (elAvail) elAvail.textContent = avail;
            const elBusy = document.getElementById('stat-busy-count'); if (elBusy) elBusy.textContent = busy;
            const elTotal = document.getElementById('fleet-total-count'); if (elTotal) elTotal.textContent = total;
        };

        const renderRequests = () => {
            const list = document.getElementById('request-queue-list');
            if (!list) return;
            list.innerHTML = (requestsData || []).map(req => `
                <div class="border border-gray-200 rounded-xl p-4 bg-white hover:shadow-lg transition-all">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border border-gray-300 text-gray-700">REQ-${req.id}</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white uppercase">${req.status}</span>
                            </div>
                            <div class="mb-2 font-medium text-gray-800">${req.emergencyType || 'Emergency'}</div>
                            <div class="text-sm text-gray-500 space-y-1">
                                <div class="flex items-start gap-2"><i class="fas fa-map-pin h-4 w-4 text-primary mt-0.5"></i><span>${req.pickup}</span></div>
                                <div class="flex items-start gap-2"><i class="fas fa-hospital h-4 w-4 text-success mt-0.5"></i><span>${req.destination}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            const badge = document.getElementById('request-count-badge');
            if (badge) badge.textContent = (requestsData || []).length;
        };

        const renderActiveTrips = () => {
            const list = document.getElementById('active-trips-list');
            if (!list) return;
            list.innerHTML = (activeTripsData || []).map(trip => `
                <div class="p-4 bg-white rounded-xl border border-gray-200 border-l-4 border-l-primary shadow-sm">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border border-gray-300 text-gray-700">${trip.id}</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white">${trip.ambulance}</span>
                            </div>
                            <div class="text-sm text-gray-500 mb-1">${trip.driver}</div>
                            <div class="text-sm text-gray-800"><span class="font-medium">Pickup:</span> ${trip.pickup}</div>
                            <div class="text-sm text-gray-800"><span class="font-medium">Drop:</span> ${trip.destination}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500 mb-1">ETA</div>
                            <div class="text-xl font-bold text-primary">${trip.eta || 0}m</div>
                        </div>
                    </div>
                </div>
            `).join('');
            const count = document.getElementById('active-trips-count');
            if (count) count.textContent = (activeTripsData || []).length;
        };

        const renderSystemAlerts = () => {
            const list = document.getElementById('system-alerts-list');
            if (!list) return;
            list.innerHTML = (systemAlertsData || []).map(alert => `
                <div class="p-3 rounded-lg text-sm ${getAlertColorClasses(alert.type)}">
                    <div class="mb-1 font-medium">${alert.message}</div>
                    <div class="text-xs text-gray-500">${alert.time}</div>
                </div>
            `).join('');
        };

        // --- Metrics ---
        const loadMetrics = async () => {
            try {
                const res = await fetch(`${API_BASE}/api/metrics`, {
                    headers: { ...(getToken() ? { 'Authorization': `Bearer ${getToken()}` } : {}) }
                });
                if (!res.ok) throw new Error('metrics failed');
                const data = await res.json();
                const qs = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
                qs('m-users-total', data.users?.total ?? 0);
                qs('m-users-drivers', data.users?.drivers ?? 0);
                qs('m-req-total', data.requests?.total ?? 0);
                qs('m-req-completed', data.requests?.completed ?? 0);
                qs('m-amb-total', data.ambulances?.total ?? 0);
                qs('m-amb-available', data.ambulances?.available ?? 0);
                const active = (data.requests?.accepted ?? 0) + (data.requests?.enroute ?? 0) + (data.requests?.arrived ?? 0) + (data.requests?.transporting ?? 0);
                qs('m-req-active', active);
                qs('m-req-pending', data.requests?.pending ?? 0);
            } catch {}
        };
        const renderQuickMessages = () => {
            const list = document.getElementById('quick-messages-list');
            list.innerHTML = quickMessagesData.map(msg => `
                <div class="p-3 rounded-lg bg-gray-50 text-sm">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-semibold ${msg.color}">${msg.from}</span>
                        <span class="text-xs text-gray-500">${msg.time}</span>
                    </div>
                    <div class="text-xs text-gray-800">${msg.message}</div>
                </div>
            `).join('');
        };

        const loadQuickMessages = async () => {
            try {
                const res = await fetch(`${API_BASE}/api/broadcasts`, {
                    headers: {
                        ...(getToken() ? { 'Authorization': `Bearer ${getToken()}` } : {})
                    }
                });
                if (!res.ok) throw new Error('fetch failed');
                const data = await res.json();
                // Expecting: { messages: [{ id, from, message, createdAt }] }
                const msgs = (data.messages || []).map(m => ({
                    from: m.from || 'Dispatcher',
                    message: m.message || '',
                    time: m.createdAt ? new Date(m.createdAt).toLocaleString() : '',
                    color: 'text-secondary'
                }));
                quickMessagesData = msgs;
            } catch {}
            renderQuickMessages();
        };
        
        // --- QUICK MESSAGE SEND ---
        const sendBroadcast = async () => {
            const textarea = document.getElementById('broadcast-textarea');
            if (!textarea) return;
            const text = textarea.value.trim();
            if (!text) return;
            // Optimistically update UI
            quickMessagesData.unshift({ from: 'Dispatcher', message: text, time: 'just now', color: 'text-secondary' });
            renderQuickMessages();
            textarea.value = '';
            // Optional: send to backend if endpoint exists
            try {
                const res = await fetch(`${API_BASE}/api/broadcast`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(getToken() ? { 'Authorization': `Bearer ${getToken()}` } : {})
                    },
                    body: JSON.stringify({ message: text })
                });
                if (res.ok) {
                    // refresh from server to reflect canonical data ordering/format
                    await loadQuickMessages();
                }
            } catch {}
        };
        
        // --- TABS LOGIC ---
        
        const handleTabClick = (e) => {
            const tabContainer = document.getElementById('tabs-content-container');
            const targetTab = e.target.getAttribute('data-tab');
            // Deactivate all triggers and content
            document.querySelectorAll('.tabs-trigger').forEach(trigger => {
                trigger.classList.remove('active');
            });
            document.querySelectorAll('.tabs-content').forEach(content => {
                content.classList.remove('active');
            });

            // Activate the clicked trigger and corresponding content
            e.target.classList.add('active');
            document.getElementById(`tabs-content-${targetTab}`).classList.add('active');
        };

        const loadData = async () => {
            try {
                const res = await fetch(`${API_BASE}/api/requests`);
                if (res.ok) {
                    const data = await res.json();
                    const all = data.requests || [];
                    requestsData = all.filter(r => r.status === 'pending');
                    activeTripsData = all.filter(r => ['accepted','enroute','arrived','transporting'].includes(r.status)).map(r => ({
                        id: `TRP-${r.id}`,
                        ambulance: r.assignedAmbulanceId ? `AMB-${r.assignedAmbulanceId}` : 'TBD',
                        driver: 'Assigned',
                        patient: '—',
                        pickup: r.pickup,
                        destination: r.destination,
                        status: r.status,
                        eta: (etaMap[r.id] ?? (etaMap[r.id] = Math.floor(Math.random() * (30 - 5 + 1)) + 5)),
                        progress: r.status === 'accepted' ? 25 : r.status === 'enroute' ? 50 : r.status === 'arrived' ? 75 : r.status === 'transporting' ? 90 : 0
                    }));
                }
            } catch {}
            renderRequests();
            renderActiveTrips();
        };

        const loadAmbulances = async () => {
            try {
                const res = await fetch(`${API_BASE}/api/ambulances`);
                if (res.ok) {
                    const data = await res.json();
                    fleetData = (data.ambulances || []).map(a => ({
                        id: a.id,
                        number: a.number,
                        status: a.status || 'available',
                        driver: a.driverUserId ? `Driver #${a.driverUserId}` : ''
                    }));
                }
            } catch {}
            renderFleet();
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!getToken() || getRole() !== 'dispatcher') {
                alert('Please login as a Dispatcher');
                window.location.href = 'login.html';
                return;
            }
            const dName = (localStorage.getItem('qr_name') || '').trim() || 'Dispatcher';
            const dNameEl = document.getElementById('dispatcher-name');
            if (dNameEl) dNameEl.textContent = dName;
            document.querySelectorAll('.tabs-trigger').forEach(trigger => trigger.addEventListener('click', handleTabClick));
            renderSystemAlerts();
            renderQuickMessages();
            loadAmbulances();
            loadData();
            loadMetrics();
            setInterval(() => { loadAmbulances(); loadData(); loadQuickMessages(); loadMetrics(); }, 5000);
            // Bind quick message send
            const sendBtn = document.getElementById('broadcast-send-btn');
            const textarea = document.getElementById('broadcast-textarea');
            if (sendBtn) sendBtn.addEventListener('click', sendBroadcast);
            if (textarea) textarea.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    sendBroadcast();
                }
            });
            // Footer quick nav
            document.querySelectorAll('button[data-goto-tab]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.getAttribute('data-goto-tab');
                    const trigger = document.querySelector(`.tabs-trigger[data-tab="${tab}"]`);
                    if (trigger) trigger.click();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });
        });
    </script>

</body>
</html>
