<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - QuickResponse</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Custom Tailwind Configuration and Base Styles */
        :root {
            --color-primary: #f44336; /* Red */
            --color-secondary: #1f253e; /* Deep Navy Blue */
            --color-success: #4CAF50; /* Green */
            --color-accent: #ffc107; /* Yellow/Accent for Star/Pending */
            --color-muted: #f3f4f6; /* Light gray background */
        }
        
        /* Apply Custom Colors */
        .text-primary { color: var(--color-primary); }
        .bg-primary { background-color: var(--color-primary); }
        .hover\:bg-primary\/90:hover { background-color: rgba(244, 67, 54, 0.9); }
        .border-primary\/20 { border-color: rgba(244, 67, 54, 0.2); }
        .text-secondary { color: var(--color-secondary); }
        .bg-secondary { background-color: var(--color-secondary); }
        .bg-success { background-color: var(--color-success); }
        .text-success { color: var(--color-success); }
        .bg-success\/5 { background-color: rgba(76, 175, 80, 0.05); }
        .fill-accent { fill: var(--color-accent); }
        .text-accent { color: var(--color-accent); }
        .bg-accent { background-color: var(--color-accent); }
        .bg-white\/20 { background-color: rgba(255, 255, 255, 0.2); }

        /* General Body and Container */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--color-muted);
        }

        .container {
            max-width: 1440px;
            margin: auto;
        }

        /* Specific styles for lucide-react icon replacement */
        .lucide {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: middle;
        }
        
        /* Custom colors for Statuses */
        .bg-blue-500 { background-color: #3b82f6; } /* Accepted */
        .bg-purple-500 { background-color: #a855f7; } /* Arrived */
        .bg-indigo-500 { background-color: #6366f1; } /* Transporting */

    </style>
</head>
<body class="min-h-screen bg-gray-100">

    <!-- Top Navigation -->
    <nav class="bg-white border-b sticky top-0 z-50 shadow-sm">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i class="fas fa-ambulance h-8 w-8 text-primary text-2xl"></i>
            <span class="text-xl font-semibold text-gray-800">QuickResponse</span>
          </div>
          
          <div class="flex items-center gap-4">
            <button id="emergency-request-btn"
              class="px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-primary hover:bg-primary/90 text-white shadow-lg animate-pulse text-lg"
            >
              <i class="fas fa-ambulance mr-2 h-5 w-5"></i>
              Emergency Request
            </button>
            
            <button class="w-10 h-10 p-0 rounded-lg bg-transparent text-gray-700 hover:bg-gray-100 relative">
              <i class="fas fa-bell h-5 w-5"></i>
              <span class="absolute -top-1 -right-1 w-5 h-5 bg-primary rounded-full text-xs text-white flex items-center justify-center">3</span>
            </button>
            
            <div class="w-10 h-10 rounded-full bg-secondary text-white flex items-center justify-center cursor-pointer">
              JD
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <div class="mb-6 flex items-center justify-between">
            <div>
                <h1 class="text-3xl mb-2 font-semibold text-gray-800">Welcome back, John</h1>
                <p class="text-gray-500">Manage your emergency requests and health profile</p>
            </div>
            <button onclick="window.location.href='index.html'" class="px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 shadow-sm">
                <i class="fas fa-sign-out-alt mr-2 h-4 w-4"></i>
                Exit Dashboard
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Quick Actions & Active Trip -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Quick Action Panel -->
                <div id="quick-action" class="bg-white rounded-xl border-2 border-gray-200 p-6 shadow-lg">
                    <h2 class="mb-6 flex items-center gap-2 text-xl font-semibold text-gray-800">
                        <i class="fas fa-ambulance h-6 w-6 text-primary"></i>
                        Request Ambulance
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="pickupLocation" class="block mb-2 text-sm font-medium text-gray-700">Pickup Location</label>
                            <div class="relative">
                                <i class="fas fa-map-pin absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                                <input type="text" id="pickupLocation"
                                    placeholder="Enter pickup address"
                                    class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                />
                            </div>
                        </div>
                        
                        <div>
                            <label for="destination" class="block mb-2 text-sm font-medium text-gray-700">Destination Hospital</label>
                            <div class="relative">
                                <i class="fas fa-hospital absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                                <input type="text" id="destination"
                                    placeholder="Select or enter hospital"
                                    class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                />
                            </div>
                        </div>
                        
                        <div>
                            <label for="emergencyType" class="block mb-2 text-sm font-medium text-gray-700">Emergency Type</label>
                            <select id="emergencyType" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <option value="" disabled selected>Select emergency type</option>
                                <option value="cardiac">Cardiac Emergency</option>
                                <option value="accident">Accident / Trauma</option>
                                <option value="respiratory">Respiratory Distress</option>
                                <option value="stroke">Stroke</option>
                                <option value="other">Other Emergency</option>
                            </select>
                        </div>
                        
                        <div class="flex gap-3 pt-2">
                            <button id="confirm-booking-btn"
                                class="flex-1 px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-primary hover:bg-primary/90 text-white shadow-md text-lg disabled:opacity-50"
                                disabled
                            >
                                <i class="fas fa-ambulance mr-2 h-5 w-5"></i>
                                Confirm Booking
                            </button>
                            <button class="px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 shadow-sm">
                                Use My Location
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Active Trip -->
                <div id="active-trip-card" style="display: none;" class="bg-white rounded-xl border-2 border-primary/20 p-6 shadow-xl opacity-0 transition-opacity duration-300">
                    <!-- Content will be populated by JavaScript -->
                </div>

                <!-- Trip History -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                    <h2 class="mb-4 text-xl font-semibold text-gray-800">Trip History</h2>
                    <div id="trip-history-list" class="space-y-3">
                        <!-- History items populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Right Column - Health Profile & Saved Locations -->
            <div class="space-y-6">
                <!-- Health Profile -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                    <h3 class="mb-4 flex items-center gap-2 text-lg font-semibold text-gray-800">
                        <i class="fas fa-heart h-5 w-5 text-primary"></i>
                        Health Profile
                    </h3>
                    <div class="space-y-4">
                        <div class="space-y-3">
                            <div>
                                <div class="text-sm text-gray-500 mb-1">Blood Type</div>
                                <div class="flex items-center gap-2">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white">O+</span>
                                </div>
                            </div>
                            <div class="h-px bg-gray-200"></div>
                            <div>
                                <div class="text-sm text-gray-500 mb-1">Allergies</div>
                                <div class="text-sm text-gray-800">Penicillin, Peanuts</div>
                            </div>
                            <div class="h-px bg-gray-200"></div>
                            <div>
                                <div class="text-sm text-gray-500 mb-1">Emergency Contact</div>
                                <div class="text-sm text-gray-800">Jane Doe - +1 234 567 8910</div>
                            </div>
                            <div class="h-px bg-gray-200"></div>
                            <div>
                                <div class="text-sm text-gray-500 mb-1">Insurance</div>
                                <div class="text-sm text-gray-800">Blue Cross - #BC123456</div>
                            </div>
                            <button class="w-full mt-2 px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 shadow-sm">
                                <i class="fas fa-cog mr-2 h-4 w-4"></i>
                                Edit Profile
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Saved Locations -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                    <h3 class="mb-4 text-lg font-semibold text-gray-800">Saved Locations</h3>
                    <div class="space-y-3">
                        
                        <div class="flex items-start gap-3 p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors">
                            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600">
                                <i class="fas fa-home h-4 w-4"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm mb-1 font-medium text-gray-800">Home</div>
                                <div class="text-xs text-gray-500">123 Main Street, Downtown</div>
                            </div>
                        </div>

                        <div class="flex items-start gap-3 p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors">
                            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600">
                                <i class="fas fa-building h-4 w-4"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm mb-1 font-medium text-gray-800">Work</div>
                                <div class="text-xs text-gray-500">456 Business Ave, Suite 100</div>
                            </div>
                        </div>

                        <div class="flex items-start gap-3 p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors">
                            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600">
                                <i class="fas fa-heart h-4 w-4"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm mb-1 font-medium text-gray-800">Preferred Hospital</div>
                                <div class="text-xs text-gray-500">Central City Hospital</div>
                            </div>
                        </div>

                        <button class="w-full px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 shadow-sm">
                            <i class="fas fa-map-marker-alt mr-2 h-4 w-4"></i>
                            Add Location
                        </button>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="p-6 rounded-xl text-white shadow-xl" style="background: linear-gradient(to bottom right, var(--color-secondary), #2A4A6F);">
                    <h3 class="mb-4 text-lg font-semibold">Your Stats</h3>
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <div class="text-2xl font-bold">12</div>
                            <div class="text-sm text-white/70">Total Trips</div>
                        </div>
                        <div class="h-px bg-white/20"></div>
                        <div class="space-y-1">
                            <div class="text-2xl font-bold">$4,520</div>
                            <div class="text-sm text-white/70">Total Spent</div>
                        </div>
                        <div class="h-px bg-white/20"></div>
                        <div class="space-y-1">
                            <div class="text-2xl font-bold">98%</div>
                            <div class="text-sm text-white/70">Success Rate</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- JavaScript Logic for Dashboard Functionality ---
        const API_BASE = 'http://127.0.0.1:5000';
        const getToken = () => localStorage.getItem('qr_token');

        // Data from backend
        let tripHistoryData = [];

        let activeTripState = null;
        let activeRequestId = null;
        let pollInterval = null;
        
        // DOM Elements
        const quickActionCard = document.getElementById('quick-action');
        const activeTripCard = document.getElementById('active-trip-card');
        const confirmBookingBtn = document.getElementById('confirm-booking-btn');
        const historyList = document.getElementById('trip-history-list');
        const pickupInput = document.getElementById('pickupLocation');
        const destinationInput = document.getElementById('destination');
        const emergencySelect = document.getElementById('emergencyType');

        // Helper Functions
        const getStatusColor = (status) => {
            switch (status) {
                case 'pending': return 'bg-accent'; // Yellow
                case 'accepted': return 'bg-blue-500';
                case 'enroute': return 'bg-primary'; // Red
                case 'arrived': return 'bg-purple-500';
                case 'transporting': return 'bg-indigo-500';
                case 'completed': return 'bg-success'; // Green
                default: return 'bg-gray-500';
            }
        };

        const getStatusLabel = (status) => {
            switch (status) {
                case 'pending': return 'Finding Ambulance...';
                case 'accepted': return 'Ambulance Assigned';
                case 'enroute': return 'On the Way';
                case 'arrived': return 'Ambulance Arrived';
                case 'transporting': return 'Transporting';
                case 'completed': return 'Trip Completed';
                default: return status;
            }
        };

        const getProgressPercentage = (status) => {
            switch (status) {
                case 'pending': return 10;
                case 'accepted': return 25;
                case 'enroute': return 50;
                case 'arrived': return 75;
                case 'transporting': return 90;
                case 'completed': return 100;
                default: return 0;
            }
        };

        // --- Rendering Functions ---

        const renderActiveTrip = () => {
            if (!activeTripState) {
                activeTripCard.style.display = 'none';
                activeTripCard.classList.remove('opacity-100');
                return;
            }
            
            const trip = activeTripState;
            
            const driverInfoHtml = trip.driver ? `
                <div class="bg-gray-100 rounded-xl p-4 mb-4">
                    <div class="flex items-center gap-4">
                        <div class="h-14 w-14 rounded-full bg-secondary text-white flex items-center justify-center text-lg font-semibold flex-shrink-0">
                            ${trip.driver.name.split(' ').map(n => n[0]).join('')}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-gray-800">${trip.driver.name}</span>
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-800">EMT Certified</span>
                            </div>
                            <div class="flex items-center gap-3 text-sm text-gray-500 mt-1">
                                <span class="flex items-center gap-1">
                                    <i class="fas fa-star h-4 w-4 fill-accent text-accent" style="color: var(--color-accent);"></i>
                                    ${trip.driver.rating}
                                </span>
                                <span>•</span>
                                <span>${trip.driver.ambulanceNumber}</span>
                            </div>
                        </div>
                        <a href="tel:${trip.driver.phone}" class="px-3 py-2 rounded-lg text-white bg-success hover:bg-green-600 flex items-center justify-center text-sm font-medium">
                            <i class="fas fa-phone h-4 w-4"></i>
                        </a>
                    </div>
                </div>
            ` : '';

            const etaHtml = trip.eta ? `
                <div class="bg-primary/10 rounded-xl p-4 text-center mb-4">
                    <div class="text-sm text-gray-500 mb-1">Estimated Time of Arrival</div>
                    <div class="text-3xl font-bold text-primary">${trip.eta} min</div>
                </div>
            ` : '';

            const statusSteps = ['pending', 'accepted', 'enroute', 'arrived', 'completed'];
            const currentStepIndex = statusSteps.indexOf(trip.status);
            
            const progressHtml = statusSteps.map((status, index) => `
                <div class="text-center">
                    <div class="w-8 h-8 rounded-full mx-auto mb-1 flex items-center justify-center text-white text-xs font-bold ${
                        currentStepIndex >= index ? getStatusColor(status) : 'bg-gray-300'
                    }">
                        ${index + 1}
                    </div>
                    <div class="text-xs text-gray-500 truncate">${status}</div>
                </div>
            `).join('');

            activeTripCard.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="flex items-center gap-2 text-xl font-semibold text-gray-800">
                        <div class="w-3 h-3 rounded-full ${getStatusColor(trip.status)} animate-pulse"></div>
                        Active Trip
                    </h2>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(trip.status)} text-white">
                        ${getStatusLabel(trip.status)}
                    </span>
                </div>

                <!-- Progress Timeline -->
                <div class="mb-6">
                    <div class="flex justify-between mb-2 text-sm text-gray-500">
                        <span>Trip Progress</span>
                        <span>${getProgressPercentage(trip.status)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full ${getStatusColor(trip.status)}" style="width: ${getProgressPercentage(trip.status)}%"></div>
                    </div>
                    
                    <div class="grid grid-cols-5 gap-2 mt-4">
                        ${progressHtml}
                    </div>
                </div>

                <!-- Trip Details -->
                <div class="space-y-4 mb-6">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-map-pin h-5 w-5 text-primary"></i>
                        </div>
                        <div class="flex-1 text-left">
                            <div class="text-sm text-gray-500">Pickup</div>
                            <div class="font-medium text-gray-800">${trip.pickupLocation}</div>
                        </div>
                    </div>
                    
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full bg-success/10 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-hospital h-5 w-5 text-success"></i>
                        </div>
                        <div class="flex-1 text-left">
                            <div class="text-sm text-gray-500">Destination</div>
                            <div class="font-medium text-gray-800">${trip.destination}</div>
                        </div>
                    </div>
                </div>

                ${driverInfoHtml}
                ${etaHtml}

                <!-- Actions -->
                <div class="grid grid-cols-3 gap-3">
                    <button class="flex-col h-auto py-3 px-3 rounded-lg text-gray-700 border border-gray-300 hover:bg-gray-50 text-sm">
                        <i class="fas fa-comment-alt h-5 w-5 mb-1"></i>
                        <span class="text-xs">Message</span>
                    </button>
                    <button class="flex-col h-auto py-3 px-3 rounded-lg text-gray-700 border border-gray-300 hover:bg-gray-50 text-sm">
                        <i class="fas fa-share-alt h-5 w-5 mb-1"></i>
                        <span class="text-xs">Share Location</span>
                    </button>
                    <button class="flex-col h-auto py-3 px-3 rounded-lg border border-primary text-primary hover:bg-primary/10 text-sm">
                        <i class="fas fa-phone h-5 w-5 mb-1"></i>
                        <span class="text-xs">Call 911</span>
                    </button>
                </div>
            `;
            
            activeTripCard.style.display = 'block';
            setTimeout(() => activeTripCard.classList.add('opacity-100'), 10);
        };

        const renderHistory = () => {
            historyList.innerHTML = tripHistoryData.map(trip => `
                <div class="bg-gray-50 rounded-xl p-4 hover:shadow-md transition-shadow cursor-pointer">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1 text-left">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border border-gray-300 text-gray-700">${trip.id}</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-success text-white">Completed</span>
                                ${trip.emergencyType === 'Accident' ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white">Emergency</span>` : ''}
                            </div>
                            <div class="space-y-1 text-sm">
                                <div class="flex items-center gap-2 text-gray-500">
                                    <i class="fas fa-map-pin h-4 w-4"></i>
                                    ${trip.pickupLocation}
                                </div>
                                <div class="flex items-center gap-2 text-gray-500">
                                    <i class="fas fa-hospital h-4 w-4"></i>
                                    ${trip.destination}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="mb-1 font-semibold text-gray-800">$${trip.cost}</div>
                            <div class="text-xs text-gray-500">
                                ${trip.timestamp.toLocaleDateString()}
                            </div>
                        </div>
                    </div>
                    <div class="h-px bg-gray-200 my-3"></div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-sm text-gray-800">
                            <i class="fas fa-user h-4 w-4 text-gray-500"></i>
                            <span>${trip.driver?.name}</span>
                            <i class="fas fa-star h-3 w-3 fill-accent" style="color: var(--color-accent);"></i>
                            <span class="text-gray-500">${trip.driver?.rating}</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="px-3 py-1.5 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">View Details</button>
                            <button class="px-3 py-1.5 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300 hover:bg-gray-50">Book Again</button>
                        </div>
                    </div>
                </div>
            `).join('');
        };


        // --- Event Handlers & State Updates ---

        const handleBookAmbulance = async () => {
            const pickup = pickupInput.value;
            const destination = destinationInput.value;
            const emergency = emergencySelect.value;
            
            if (!pickup || !destination || !emergency) {
                alert("Please fill out all request details.");
                return;
            }
            try {
                confirmBookingBtn.disabled = true;
                const res = await fetch(`${API_BASE}/api/requests`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(getToken() ? { 'Authorization': `Bearer ${getToken()}` } : {})
                    },
                    body: JSON.stringify({ pickup, destination, emergencyType: emergency })
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({ error: 'Failed to create request' }));
                    throw new Error(err.error || 'Failed to create request');
                }
                const data = await res.json();
                const req = data.request;
                activeRequestId = req.id;
                activeTripState = {
                    id: `TRP-${req.id}`,
                    status: req.status,
                    pickupLocation: req.pickup,
                    destination: req.destination,
                    emergencyType: req.emergencyType,
                    timestamp: new Date(),
                    eta: null,
                    driver: null
                };
                renderActiveTrip();
                startPollingStatus();
            } catch (e) {
                alert(e.message);
                confirmBookingBtn.disabled = false;
            }
        };

        const checkFormValidity = () => {
            const isReady = pickupInput.value.trim() !== '' && 
                            destinationInput.value.trim() !== '' && 
                            emergencySelect.value !== '';
            confirmBookingBtn.disabled = !isReady;
        };

        const startPollingStatus = () => {
            if (!activeRequestId) return;
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/requests/${activeRequestId}`);
                    if (!res.ok) return;
                    const data = await res.json();
                    const r = data.request;
                    if (!activeTripState) return;
                    activeTripState.status = r.status;
                    renderActiveTrip();
                    if (r.status === 'completed' || r.status === 'cancelled') {
                        // If completed, append to history and clear active card
                        if (r.status === 'completed') {
                            tripHistoryData.unshift({
                                id: `TRP-${r.id}`,
                                pickupLocation: r.pickup,
                                destination: r.destination,
                                emergencyType: r.emergencyType,
                                cost: 0,
                                timestamp: new Date(r.createdAt),
                                driver: null
                            });
                            renderHistory();
                        }
                        activeTripState = null;
                        renderActiveTrip();
                        clearInterval(pollInterval);
                        pollInterval = null;
                    }
                } catch {}
            }, 3000);
        };

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', async () => {
            // Load existing requests of the logged-in user (if any)
            try {
                const token = getToken();
                if (token) {
                    const res = await fetch(`${API_BASE}/api/my/requests`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        const reqs = data.requests || [];
                        // active = first non-completed/non-cancelled if any
                        const active = reqs.find(r => !['completed','cancelled'].includes(r.status));
                        if (active) {
                            activeRequestId = active.id;
                            activeTripState = {
                                id: `TRP-${active.id}`,
                                status: active.status,
                                pickupLocation: active.pickup,
                                destination: active.destination,
                                emergencyType: active.emergencyType,
                                timestamp: new Date(),
                                eta: null,
                                driver: null
                            };
                            startPollingStatus();
                        }
                        // history = completed ones
                        tripHistoryData = reqs
                            .filter(r => r.status === 'completed')
                            .map(r => ({
                                id: `TRP-${r.id}`,
                                pickupLocation: r.pickup,
                                destination: r.destination,
                                emergencyType: r.emergencyType,
                                cost: 0,
                                timestamp: new Date(r.createdAt),
                                driver: null
                            }));
                    }
                }
            } catch {}

            // Set up listeners for form validation
            [pickupInput, destinationInput, emergencySelect].forEach(input => {
                input.addEventListener('input', checkFormValidity);
            });

            // Set up booking handler
            document.getElementById('confirm-booking-btn').addEventListener('click', handleBookAmbulance);
            
            // Initial renders
            renderActiveTrip();
            renderHistory();
            
            // Scroll to Quick Action on emergency button click
            document.getElementById('emergency-request-btn').addEventListener('click', () => {
                const target = document.getElementById('quick-action');
                if (target) {
                    window.scrollTo({ top: target.offsetTop - 80, behavior: 'smooth' }); // -80 for sticky nav height
                }
            });
            
        });
    </script>

</body>
</html>
